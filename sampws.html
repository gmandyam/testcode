<html>
<head>
  <title>HTML5 WebSocket Demo</title>
  <style type="text/css">
  .ours {
      color: #0000ff;
  }
  .theirs {
      color: #ff0000;
  }
  .system {
      color: #333333;
      font-style: italic;
  }
  </style>
  <script type="text/javascript">
    // the websocket object
    var websocket;
    var timer_var;
    // our chat handle
    var handle = "";
    var target_batt_level = .83;
    var target_ws_send_tests = 50;
    var idx_flag = true;
    var invocation = new XMLHttpRequest;
    var url = 'http://127.0.0.1:8080'; 
    // the address of the websocket server
    var server = "ws://127.0.0.1:8080";
    var batt_array = new Array;
    var idx = 0;
    localStorage.serverURL = server;
    var battery = navigator.battery || navigator.mozBattery || navigator.webkitBattery; 
    
    function pausecomp(ms) {
        ms += new Date().getTime();
        while (new Date() < ms){}
        } 
    

        function callOtherDomain()
        {
            if (invocation)
            {
                invocation.open('GET', url, true);
                invocation.onreadystatechange = handler;
                invocation.send();
            }
            else
            {
                var text = "No Invocation TookPlace At All";
                var textNode = document.createTextNode(text);
                var textDiv = document.getElementById("textDiv");
                textDiv.appendChild(textNode);
            }
        }
        
        function handler(evtXHR)
        {
            if (invocation.readyState == 4)
            {
                if (invocation.status == 200)
                {
                    outputResult();
                }
                else
                {
                    alert("Invocation Errors Occured");
                }
            }
        }

        function outputResult()
        {
            var response = invocation.responseText;
            console("XHR message received is " + response);
        }


    
    function init()
    {
        // disable buttons
        $('send').disabled = true;
        $('disconnect').disabled = true;
        $('connect').disabled = true;
        $('message').disabled = true;

        // test for websocket support
        if ("WebSocket" in window) {
            $('connect').disabled = false;
            console("system|Browser appears to support WebSockets!");
            console("system|Click \"Connect\" to attempt connection");

            // connect handler
            $('connect').onclick = function() {
                if (!$('handle').value) {
                    alert('Please enter a chat handle');
                    return;
                }
                handle = $('handle').value;
                console("system|connecting to "+server);

                // creating a WebSocket object causes it
                // to connect to the server
                websocket = new WebSocket(server);
                idx = 0;
                // called once the connection is established
                websocket.onopen = function(evt) {
                    console("system|CONNECTED");
                    $('connect').disabled = true;
                    $('disconnect').disabled = false;
                    $('send').disabled = false;
                    $('message').disabled = false;
                    $('handle').disabled = true;
                    // broadcast that we've connected
                    websocket.send("system|"+handle+" connected");
                    tstamp = new Date().getTime().toString();
                    batri = navigator.mozBattery.level.toString();
                    batt_array[idx] = [tstamp,batri];
                    idx=idx+1;
                };

                // called upon receipt of a message
                websocket.onmessage = function(evt) {
                    rcvd = evt.data;
                    //idx = rcvd.indexOf(":");
                    console("Message from server received:");
                    console(rcvd);
                };

                // called when an error occurs
                websocket.onerror = function(evt) {
                    console("system|Websocket error: "+evt.data);
                };

                // called when the connection is closed (by either side)
                websocket.onclose = function() {
                    console("system|DISCONNECTED");
                    $('connect').disabled = false;
                    $('disconnect').disabled = true;
                    $('send').disabled = true;
                    $('message').disabled = true;
                    $('handle').disabled = false;
                };
            };

        } else { // no websocket support
            $('error').innerHTML = "Your browser does not appear to support WebSockets";
            }
        
        // send message handler
        $('send').onclick = function() {
            if (idx_flag) {
                while (idx < target_ws_send_tests){
                    websocket.send(handle+"|"+$('message').value);
                    console("Sent message");
                    tstamp = new Date().getTime().toString();
                    batri = navigator.mozBattery.level.toString();
                    batt_array[idx] = [tstamp,batri];
                    idx=idx+1;
                    pausecomp(1000);
                    };
                }
            else {
                while (navigator.mozBattery.level > target_batt_level){
                    websocket.send(handle+"|"+$('message').value);
                    console("Sent message");
                    tstamp = new Date().getTime().toString();
                    batri = navigator.mozBattery.level.toString();
                    batt_array[idx] = [tstamp,batri];
                    idx=idx+1;
                    pausecomp(1000);
                    };
                }
            console("Battery level low; switching to XHR");
            websocket.send("system|"+handle+" disconnected");
            websocket.close;
            timer_var = setInterval(function() {
                            callOtherDomain();
                            tstamp = new Date().getTime().toString();
                            batri = navigator.mozBattery.level.toString();
                            batt_array[idx] = [tstamp,batri];
                            idx = idx+1;   
                            }, 4000);                   
            //$('message').value = "";
            $('message').focus();
        }
        

            
        // disconnect handler
        $('disconnect').onclick = function() {
            // broadcast that we've left the chat
            if (((idx_flag) && (idx >= target_ws_send_tests)) || ((~idx_flag) && (navigator.mozBattery.level <= target_batt_level))) {
                clearInterval(timer_var);
                }
            else {
                websocket.send("system|"+handle+" disconnected");
                websocket.close(); // close the connection
                };
        }
    }

    // helper function
    function $(id){ return document.getElementById(id); }

    // function to display status and message output
    function console(message)
    {
        // normal messages are of the form "handle|text"
        var msg = message.split("|",2);
        var msg_text = (msg.length > 1) ? msg[1] : msg[0];
        var msg_handle = (msg.length > 1) ? msg[0] : "";

        var pre = document.createElement("pre");
        pre.style.wordWrap = "break-word";
        pre.style.padding = "0 5px";
        pre.style.margin = "0";
        pre.innerHTML = msg_text;

        // "system" messages
        if (msg_handle == "system") {
            pre.className = "system";
            msg_handle = "";
        }

        // did we receive a handle?
        if (msg_handle.length > 0) {
            // if so, then prepend the handle to the message content
            var h = document.createElement("span");
            h.innerHTML = msg_handle + ": ";

            // is it ours or theirs
            if (msg_handle == handle) {
                h.className = "ours";
            } else {
                h.className = "theirs";
            }
            pre.insertBefore(h, pre.firstChild);
        }
        // add the new message at the end
        $('console').appendChild(pre);

        // scroll to bottom of console
        $('console').scrollTop = $('console').scrollHeight;
    }

  </script>
<body onload="init()">

<h3>HTML 5 WebSocket Demo</h3>

<h4 id="error" style="color:#ff0000"></h4>
<div>
    <div id="console" style="height:300px; overflow:scroll; border:1px solid black"></div>
</div>
<div style="padding-top:10px">
    <label>Handle:</label><input id="handle" size="25" value="">
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button><br>
    <label>Message:</label><input id="message" size="25" value="">
    <button id="send">Send</button>
</div>


</body>
</html>
